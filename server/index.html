<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="images/favicon.ico">

  <title>Morphee</title>

  <!-- Vendors Style-->
  <link rel="stylesheet" href="css/vendors_css.css">

  <!-- Style-->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/skin_color.css">
  <link href="custom/jsoneditor-9.1.4/jsoneditor.min.css" rel="stylesheet" type="text/css">

</head>
<body class="hold-transition dark-skin sidebar-mini theme-primary fixed sidebar-collapse">
  <div class="wrapper">
    <div id="loader"></div>

    <header class="main-header">
      <div class="d-flex align-items-center logo-box justify-content-start">
        <a href="#" class="waves-effect waves-light nav-link d-none d-md-inline-block mx-10 push-btn bg-transparent" data-toggle="push-menu" role="button">
          <span class="icon-Align-left"><span class="path1"></span><span class="path2"></span><span class="path3"></span></span>
        </a>
        <!-- Logo -->
        <a href="index.html" class="logo">
          <!-- logo-->
          <div class="logo-lg">
          </div>
        </a>
      </div>
      <!-- Header Navbar -->
      <nav class="navbar navbar-static-top">
        <!-- Sidebar toggle button-->
        <div class="app-menu">
          <ul class="header-megamenu nav">
            <li class="btn-group nav-item d-md-none">
              <a href="#" class="waves-effect waves-light nav-link push-btn" data-toggle="push-menu" role="button">
                <span class="icon-Align-left"><span class="path1"></span><span class="path2"></span><span class="path3"></span></span>
              </a>
            </li>
          </ul>
        </div>
      </nav>
    </header>

    <!-- Left side column. contains the logo and sidebar -->
    <aside class="main-sidebar">
      <!-- sidebar-->
      <section class="sidebar position-relative">
        <div class="multinav">
        <div class="multinav-scroll" style="height: 100%;">
          <!-- sidebar menu-->
          <ul class="sidebar-menu" data-widget="tree">
          <li class="header">Carte</li>
          <li class="treeview">
            <a href="#">
            <i class="fa fa-id-card""><span class="path1"></span><span class="path2"></span></i>
            <span>Carte</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-right pull-right"></i>
            </span>
            </a>
            <ul class="treeview-menu">
              <li><a href="index.html"><i class="icon-Commit"><span class="path1"></span><span class="path2"></span></i>Encodage</a></li>
            </ul>
          </li>
<!--

          <li class="treeview">
            <a href="#">
            <i span class="icon-Layout-grid"><span class="path1"></span><span class="path2"></span></i>
            <span>Apps</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-right pull-right"></i>
            </span>
            </a>
            <ul class="treeview-menu">
            <li><a href="extra_calendar.html"><i class="icon-Commit"><span class="path1"></span><span class="path2"></span></i>Calendar</a></li>
            <li><a href="contact_app.html"><i class="icon-Commit"><span class="path1"></span><span class="path2"></span></i>Contact List</a></li>
            <li><a href="contact_app_chat.html"><i class="icon-Commit"><span class="path1"></span><span class="path2"></span></i>Chat</a></li>
            <li><a href="extra_taskboard.html"><i class="icon-Commit"><span class="path1"></span><span class="path2"></span></i>Todo</a></li>
            <li><a href="mailbox.html"><i class="icon-Commit"><span class="path1"></span><span class="path2"></span></i>Mailbox</a></li>
            </ul>
          </li>
-->
          </ul>
        </div>
      </div>
      </section>
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <div class="container-full">
      <!-- Content Header (Page header) -->
      <div class="content-header">
        <div class="d-flex align-items-center">
          <div class="me-auto">
            <h3 class="page-title">Encodage</h3>
            <div class="d-inline-block align-items-center">
              <nav>
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="#"><i class="mdi mdi-home-outline"></i></a></li>
                  <li class="breadcrumb-item" aria-current="page">Carte</li>
                  <li class="breadcrumb-item active" aria-current="page">Encodage</li>
                </ol>
              </nav>
            </div>
          </div>

        </div>
      </div>

      <!-- Main content -->
      <section class="content">

        <div class="row">
          <div class="col-12">
          <div class="box">
            <div class="box-header with-border">
              <h4 class="box-title">Détails</h4>
            </div>
            <div class="box-body">
            <form action="#">
              <div class="form-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="fw-700 fs-16 form-label">Style</label>
                      <div class="col-12">
                        <div class="form-group row">
                          <label for="btn-style" class="col-sm-2 col-form-label">Prédéfini</label>
                          <div class="col-sm-10">
                            <select class="form-select" id="btn-style" data-placeholder="Choisir un style" tabindex="1">
                              <option value="zen">Zen</option>
                              <option value="nature">Nature</option>
                              <option value="music" selected="selected">Musique</option>
                              <option value="relax">Relaxation</option>
                              <option value="love">Amour</option>
                            </select>
                          </div>
                        </div>
                      </div>
                      <div class="col-12">
                        <div class="form-group row">
                          <label for="btn-picto" class="col-sm-2 col-form-label">Surchargé</label>
                          <div class="col-sm-10">
                            <input type="text" class="form-control" id="btn-picto" placeholder="Picto">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="fw-700 fs-16 form-label">Mode de lecture</label>

                      <div class="col-12">
                        <div class="form-group row">
                          <label for="btn-mode-once" class="col-sm-2 col-form-label">Unique</label>
                          <div class="col-sm-10">
                            <button id="btn-mode-once" type="button" class="btn btn-sm btn-toggle btn-primary active btn-mode" data-bs-toggle="button" aria-pressed="true" autocomplete="off"><div class="handle"></div></button>
                          </div>
                        </div>
                        <div class="form-group row">
                          <label for="btn-mode-shuffle" class="col-sm-2 col-form-label">Aléatoire</label>
                          <div class="col-sm-10">
                            <button id="btn-mode-shuffle" type="button" class="btn btn-sm btn-toggle btn-primary btn-mode" data-bs-toggle="button" aria-pressed="true" autocomplete="off"><div class="handle"></div></button>
                          </div>
                        </div>
                        <div class="form-group row">
                          <label for="btn-mode-loop" class="col-sm-2 col-form-label">Boucle</label>
                          <div class="col-sm-10">
                            <button id="btn-mode-loop" type="button" class="btn btn-sm btn-toggle btn-primary btn-mode" data-bs-toggle="button" aria-pressed="true" autocomplete="off"><div class="handle"></div></button>
                          </div>
                        </div>
                        <div class="form-group row">
                          <label for="btn-keep" class="col-sm-2 col-form-label">Pistes à garder</label>
                          <div class="col-sm-10">
                            <input id="btn-keep" type="text" value="1" class="form-control" data-from="1" data-min="1" data-max="100">
                          </div>
                        </div>
                        <div class="form-group row">
                          <label for="btn-limit" class="col-sm-2 col-form-label">Temps limite (minutes)</label>
                          <div class="col-sm-10">
                            <input id="btn-limit" type="text" value="0" class="form-control" data-from="0" data-min="0" data-max="3600">
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="fw-700 fs-16 form-label">Animation</label>
                      <select class="form-select" id="btn-animation" data-placeholder="Choisir une animation" tabindex="1">
                        <option value="none" selected="selected">Aucune</option>
                        <option value="sparklepulse">Sparkle pulse</option>
                      </select>
                    </div>
                  </div>
                </div>
                <!--/row-->
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="fw-700 fs-16 form-label">Url</label>
                      <input type="text" class="form-control" id="modipy-url" placeholder="Mopidy url">
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="fw-700 fs-16 form-label">Données sur la carte</label>
                      <pre class="ace-editor" id="editorJSON" data-plugin="ace" data-mode="javascript" style="width: 100%;height: 300px;"></pre>
                    </div>
                  </div>
                </div>
                <!--/row-->
              </div>
              <div class="form-actions mt-10">
                <button type="button" id="btn-read-card" class="waves-effect waves-light btn btn-primary mb-5 me-5"> <i class="fa fa-folder-open"></i> Lire</button>
                <button type="button" id="btn-encode-card" class="waves-effect waves-light btn btn-danger mb-5"><i class="fa fa-save"></i> Encoder</button>
                <button type="button" id="btn-encode-spin" class="waves-effect waves-light btn btn-danger mb-5 visually-hidden" disabled><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>Encodage...</button>
              </div>
            </form>
            </div>
          </div>
          </div>
        </div>

      </section>
      <!-- /.content -->
      </div>
    </div>
    <!-- /.content-wrapper -->

    <footer class="main-footer">
      <div class="pull-right d-none d-sm-inline-block">
      </div>
    </footer>

    <!-- Add the sidebar's background. This div must be placed immediately after the control sidebar -->
    <div class="control-sidebar-bg"></div>
  </div>
  <!-- ./wrapper -->

  <!-- Page Content overlay -->

  <!-- Vendor JS -->
  <script src="js/vendors.min.js"></script>
  <script src="assets/icons/feather-icons/feather.min.js"></script>

  <!-- Etikto Admin App -->
  <script src="js/template.js"></script>
  <script src="assets/vendor_plugins/ace-builds-master/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="assets/vendor_components/sweetalert/sweetalert.min.js"></script>

  <!-- Custom -->
  <script src="custom/jquery/3.6.0/jquery-3.6.0.min.js"></script>
  <script src="custom/socket.io/4.0.0/socket.io.js"></script>
  <script src="custom/mqtt/5.6.0/mqtt.js"></script>
  <script src="custom/jsoneditor-9.1.4/jsoneditor.min.js"></script>
  <script src="assets/vendor_components/ion-rangeSlider/js/ion.rangeSlider.min.js"></script>
  <script>

    const zeroPad = (num, places) => String(num).padStart(places, '0')

    var animations = ['none', 'sparklepulse']
    var styles = ['zen', 'nature', 'music', 'relax', 'love']

    var editor = new JSONEditor(
      document.getElementById("editorJSON"),
      {
        mode: 'code',
        sortObjectKeys: false,
        escapeUnicode: false,
        search: false,
        enableTransform: false,
        onValidationError: function (errors) {
          if (errors.length>0) {
            $("#btn-encode-card").addClass('disabled');
          } else {
            $("#btn-encode-card").removeClass('disabled');
          }
        }
      }
    )
    editor.set({})

    var UpdateEditor = function() {

      sStyle = $('#btn-style').val();
      if (!styles.includes(sStyle))
        sStyle = 'music';

      sAnimation = $('#btn-animation').val();
      if (!animations.includes(sAnimation))
        sAnimation = 'none';

      sPicto = $('#btn-picto').val();

      var jDatas = {
        'url': $('#modipy-url').val(),
        'once': switchIsOn('#btn-mode-once'),
        'shuffle': switchIsOn('#btn-mode-shuffle'),
        'loop': switchIsOn('#btn-mode-loop'),
        'style': sStyle,
        'picto': sPicto,
        'keep': $('#btn-keep').val(),
        'limit': $('#btn-limit').val(),
        'animation': sAnimation
      }
      editor.set(jDatas)
      return jDatas
    };

    const options = {
      clean: true,
      connectTimeout: 4000,
      clientId: 'emqx_test',
    }
    const client  = mqtt.connect('ws://morphee.local:9001', options)
    client.on('connect', function () {
      console.log('Connected')
      client.subscribe('Morphee/carte/readed', function (err) {
        if (err)
          console.log('subscript fail ', err)
      })
      client.subscribe('Morphee/carte/encoded', function (err) {
        if (err)
          console.log('subscript fail ', err)
      })
    })

    client.on('message', function (topic, message) {
      console.log(topic + ' -> ' + message.toString())
      if (topic=='Morphee/carte/readed') {
        const payload = JSON.parse(message.toString());
        console.log(payload)
        if (payload.readed) {

          sStyle = payload.style;
          if (!styles.includes(sStyle))
            sStyle = 'music';

          sAnimation = payload.animation;
          if (!animations.includes(sAnimation))
            sAnimation = 'none';

          $('#modipy-url').val(payload.url);
          $('#btn-style').val(sStyle);
          $('#btn-animation').val(sAnimation);
          switchSet('#btn-mode-once', payload.once);
          switchSet('#btn-mode-shuffle', payload.shuffle);
          switchSet('#btn-mode-loop', payload.loop);
          $("#btn-limit").data("ionRangeSlider").update({from:payload.limit})
          $("#btn-keep").data("ionRangeSlider").update({from:payload.keep})
          $("#btn-picto").val('')

          UpdateEditor();
        }
      } else if (topic=='Morphee/carte/encoded') {
        $("#btn-encode-card").removeClass('disabled visually-hidden');
        $("#btn-encode-spin").addClass('visually-hidden');
        sPayload = message.toString().toLowerCase()
        console.log(sPayload)
        const payload = JSON.parse(sPayload);
        if (payload.encoded) {
          swal('La carte est encodée', 'Encodage de la carte réussi', "success")
        } else {
          swal("La carte n'est encodée", "L'encodage de la carte a échouée", "warning")
        }
      }
      console.log(message.toString())
    })

    var socket = io.connect();

    function switchIsOn(btn) {
      if ($(btn).hasClass("active"))
        return true

      return false;
    }

    function switchSet(btn, state) {
      if (state) {
        if (!switchIsOn(btn))
          $(btn).addClass("active")
      } else {
        if (switchIsOn(btn))
          $(btn).removeClass("active")
      }
    }

    $( document ).ready(function() {

      $('#modipy-url').change(function(){
        UpdateEditor();
      });
      $('#btn-picto').change(function(){
        UpdateEditor();
      });
      $('#btn-style').change(function(){
        UpdateEditor();
      });
      $('#btn-animation').change(function(){
        UpdateEditor();
      });

      $("#btn-limit").ionRangeSlider({
        onFinish: function (data) {
          UpdateEditor();
        },
      })

      $("#btn-keep").ionRangeSlider({
        onFinish: function (data) {
          UpdateEditor();
        },
      })

      $('.btn-mode').click(function(){
        UpdateEditor();
      });

      $("#btn-read-card").on("click", function(event) {
        event.preventDefault();
        //$("#btn-read-card").hide();
        var result = editor.validate();
        socket.emit("read_card");
      });
      socket.on("read_ack", (data) => {
        if (data.ack) {
            $("#btn-read-card").removeClass('disabled');
        } else {
            swal(data.title, data.message, "warning")
        }
      });

      $("#btn-encode-card").on("click", function(event) {
        event.preventDefault();
        var jDatas = editor.get()
        socket.emit("encode_card", jDatas);
      });
      socket.on("encode_ack", (data) => {
        if (data.ack) {
            $("#btn-encode-card").addClass('disabled visually-hidden');
            $("#btn-encode-spin").removeClass('visually-hidden');
        } else {
            swal(data.title, data.message, "warning")
            $("#btn-encode-card").removeClass('disabled visually-hidden');
            $("#btn-encode-spin").addClass('visually-hidden');
        }
      });

      socket.on("encoded_ack", (data) => {
        $("#btn-encode-card").removeClass('disabled ');
        $("#btn-encode-spin").addClass('visually-hidden');
      });

      UpdateEditor();

    });

  </script>

</body>
</html>
